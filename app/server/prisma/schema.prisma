generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model User {
    id            String   @id @default(cuid())
    name          String
    email         String   @unique
    emailVerified Boolean  @default(false)
    image         String?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // Custom fields
    first_name    String?
    last_name     String?
    password      String?
    role          Role?    @relation(fields: [roleId], references: [id])
    roleId        Int?
    secondaryRoles Role[]  @relation("UserSecondaryRoles") // New: Support for multiple roles
    batch         Int?
    year          Int?
    semester      Int?
    status        String?
    university_id String?  @unique

    // Relations
    sessions      Session[]
    accounts      Account[]
    resources     Resource[]
    comments      Comment[]
    ratings       Rating[]
    flags         Flag[]         @relation("FlagResolvedBy")
    reportedFlags Flag[]         @relation("FlagReportedBy")
    notifications Notification[]
    assignments   Assignment[]
    submissions   Submission[]
    blogs         Blog[]
    systemLogs    SystemLog[]
    favorites     Favorite[]

    @@map("user")
}

model Session {
    id        String   @id
    expiresAt DateTime
    token     String
    createdAt DateTime
    updatedAt DateTime
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([token])
    @@map("session")
}

model Account {
    id                    String    @id
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime
    updatedAt             DateTime

    @@map("account")
}

model Verification {
    id         String    @id
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime?
    updatedAt  DateTime?

    @@map("verification")
}

model Blog {
    id          Int      @id @default(autoincrement())
    title       String
    content     String
    image_path  String?
    published   Boolean  @default(false)
    tags        String[]
    author      User     @relation(fields: [author_id], references: [id], onDelete: Cascade)
    author_id   String
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt
}

model Role {
    id         Int      @id @default(autoincrement())
    name       String   @unique
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    users User[] // Primary relation
    secondaryRoleUsers User[] @relation("UserSecondaryRoles") // Secondary relation
}

model Design_stage {
    id         Int      @id @default(autoincrement())
    name       String
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    resources Resource[]
    assignments Assignment[]
}

model Resource {
    id              Int           @id @default(autoincrement())
    title           String
    author          String?
    // keyword         String?
    keywords        String[]
    forYearStudents           Int
    semester        Int?
    batch Int?
    file_path       String
    file_type       String?
    file_size       Float?
    uploader        User?         @relation(fields: [uploader_id], references: [id], onDelete: SetNull)
    uploader_id     String?
    design_stage    Design_stage? @relation(fields: [design_stage_id], references: [id])
    design_stage_id Int?
    status          String?
    download_count  Int?          @default(0)
    flag            Boolean?      @default(false)
    uploaded_at     DateTime?     @default(now())
    approved_at     DateTime?
    rejected_at     DateTime?
    updated_at      DateTime?     @updatedAt
    archived_at     DateTime?
    priority_tag    String?
    admin_comment   String?

    comments      Comment[]
    ratings       Rating[]
    flags         Flag[]
    notifications Notification[]
    favorites     Favorite[]
}

model Comment {
    id          Int      @id @default(autoincrement())
    text        String
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt
    resource    Resource @relation(fields: [resource_id], references: [id], onDelete: Cascade)
    resource_id Int
    user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
    user_id     String
}

model Rating {
    id          Int      @id @default(autoincrement())
    rate        Int
    user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
    user_id     String
    resource    Resource @relation(fields: [resource_id], references: [id], onDelete: Cascade)
    resource_id Int
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt
}

model Flag {
    id             Int       @id @default(autoincrement())
    resource       Resource  @relation(fields: [resource_id], references: [id], onDelete: Cascade)
    resource_id    Int
    reason         String?
    status         String?
    created_at     DateTime  @default(now())
    reporter       User?     @relation("FlagReportedBy", fields: [reporter_id], references: [id], onDelete: SetNull)
    reporter_id    String?
    resolved_at    DateTime?
    resolved_by    User?     @relation("FlagResolvedBy", fields: [resolved_by_id], references: [id], onDelete: SetNull)
    resolved_by_id String?
}

model Notification {
    id      Int      @id @default(autoincrement())
    title   String
    message String
    is_read Boolean? @default(false)

    created_at  DateTime  @default(now())
    resource    Resource? @relation(fields: [resource_id], references: [id], onDelete: Cascade)
    resource_id Int?
    assignment  Assignment? @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
    assignment_id Int?
    user        User?     @relation(fields: [user_id], references: [id], onDelete: Cascade)
    user_id     String?
    commentId   Int?
}

model Assignment {
    id              Int           @id @default(autoincrement())
    title           String
    description     String?
    due_date        DateTime?
    academic_year   Int?
    semester        Int?
    file_path       String?
    file_type       String?
    file_size       Float?
    creator         User          @relation(fields: [creator_id], references: [id], onDelete: Cascade)
    creator_id      String
    design_stage    Design_stage? @relation(fields: [design_stage_id], references: [id])
    design_stage_id Int?
    created_at      DateTime      @default(now())
    updated_at      DateTime      @updatedAt

    submissions     Submission[]
    notifications   Notification[]
}

model Submission {
    id            Int        @id @default(autoincrement())
    student       User       @relation(fields: [student_id], references: [id], onDelete: Cascade)
    student_id     String
    assignment    Assignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
    assignment_id  Int
    file_path      String
    file_type      String?
    file_size      Float?
    submitted_at   DateTime   @default(now())
    updated_at     DateTime   @updatedAt
    status         String?    @default("submitted") // e.g. submitted, graded
}

model News {
    id          Int      @id @default(autoincrement())
    title       String
    content     String
    source      String?  @default("ArchVault Admin")
    is_event    Boolean  @default(false)
    event_date  DateTime?
    published   Boolean  @default(true)
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt
}



model SystemLog {
    id          Int      @id @default(autoincrement())
    action      String
    entity      String?
    entityId    String?
    details     String?
    actor       User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)
    actorId     String?
    ipAddress   String?
    createdAt   DateTime @default(now())

    @@map("system_log")
}

model NewsletterSubscription {
    id        Int      @id @default(autoincrement())
    email     String   @unique
    createdAt DateTime @default(now())
}

model Favorite {
    id          Int      @id @default(autoincrement())
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId      String
    resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
    resourceId  Int
    createdAt   DateTime @default(now())

    @@unique([userId, resourceId])
}
